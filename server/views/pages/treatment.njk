{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - Home" %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

  {% from "moj/components/side-navigation/macro.njk" import mojSideNavigation %}
  {% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
  {% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
  {% from "govuk/components/button/macro.njk" import govukButton %}
  {% from "govuk/components/details/macro.njk" import govukDetails %}


  <form method="post">
    <input type="hidden" name="_csrf" value="{{ csrfToken }}">

    {% set errorList =[
      { text: errorMessages.genericErrorMessage.text, href: "#" } if errorMessages.genericErrorMessage else None
    ] | reject("undefined") %}

    {% if errorMessages | length > 0 %}
      {% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
      {{ govukErrorSummary({ titleText: "There is a problem", errorList: errorList }) }}
    {% endif %}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        {% include "pages/side-nav.njk" %}
      </div>

      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-l">Suicide Risk - Treatment</h1>

        <h2 class="govuk-heading-m">Any Current Psychiatric Treatment</h2>
        {{ govukCharacterCount({
          name: "currentPsychTreatment",
          id: "currentPsychTreatment",
          maxlength: 4000,
          value: suicideRisk.currentPsychTreatment
        }) }}

        <h2 class="govuk-heading-m">Contacts relating to Treatment</h2>
        {{ govukButton({
          text: "Search Contacts",
          preventDoubleClick: "true",
          type: "submit",
          name: "action",
          value: "searchContacts",
          attributes: {
            id: "search-contacts--button"
          }
        }) }}

        {% if not searchResults %}
          <p id="search-contacts-text">
            Please press the Search Contact button to view contacts containing "Psychiatric Treatment"
          </p>
        {% else %}
          <h2 class="govuk-heading-m">{{ searchResults.results.length }} Contacts found</h2>
          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

          {% if searchResults.results.length == 0 %}
            <p class="govuk-body">No contacts matched your search.</p>

          {% else %}
            {% for entry in contactsWithDocs %}
              {% set result = entry.contact %}
              {% set documents = entry.documents %}

              <div class="govuk-grid-row govuk-!-margin-bottom-3">
                <div class="govuk-grid-column-full">

                  <p class="govuk-body">
                    <strong>Date:</strong> {{ result.date | dayMonthYear }}<br>
                    <strong>Description:</strong> {{ result.description }}<br>
                    <strong>Type:</strong> {{ result.typeDescription }}<br>
                    <strong>Outcome:</strong> {{ result.outcomeDescription }}<br>
                  </p>

                  {{ govukDetails({
                    summaryText: "view contact notes",
                    text: result.notes or "No notes found for this contact"
                  }) }}

                  {% if documents.length > 0 %}

                    {% set docHtml %}
                      {% for doc in documents %}
                        <p class="govuk-body">
                          <strong>Document name:</strong> {{ doc.name | escape }}<br>
                          <strong>Last updated:</strong> {{ doc.lastUpdated | escape }}
                        </p>
                      {% endfor %}
                    {% endset %}

                    {{ govukDetails({
                      summaryText: "show document details",
                      html: docHtml
                    }) }}

                    <p>
                      <a href="{{ contactDeeplink }}{{ result.id }}" target="_blank" class="govuk-link">
                        click here to open full contact details in a new tab
                      </a>
                    </p>
                  {% else %}
                    {{ govukDetails({
                      summaryText: "show document details",
                      text: "No documents found for this contact"
                    }) }}
                  {% endif %}

                </div>
              </div>

              {% if not loop.last %}
                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}

        <div class="moj-button-group">
          {{ govukButton({
            text: "Continue",
            preventDoubleClick: "true",
            type: "submit",
            attributes: {
              id: "continue-button"
            }
          }) }}
          {{ govukButton({
            text: "Save Progress and Close",
            type: "submit",
            name: "action",
            value: "saveProgressAndClose",
            classes: "govuk-button--secondary",
            attributes: {
              id: "close-button"
            }
          }) }}
        </div>
      </div>
    </div>
  </form>

{% endblock %}
